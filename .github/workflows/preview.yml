name: Deploy Preview

on:
  push:
    branches-ignore: ["main", "gh-pages"]
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: "pages-preview-${{ github.ref_name }}"
  cancel-in-progress: true

jobs:
  preview:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build (static export)
        run: |
          SAFE_BRANCH=$(echo "${GITHUB_REF_NAME}" | tr '/' '-')
          echo "SAFE_BRANCH=${SAFE_BRANCH}" >> $GITHUB_ENV
          export NEXT_PUBLIC_BASE_PATH=/${{ github.event.repository.name }}/preview/${SAFE_BRANCH}
          npm run build

      - name: Deploy preview to gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: ./out
          destination_dir: preview/${{ env.SAFE_BRANCH }}
          keep_files: true
